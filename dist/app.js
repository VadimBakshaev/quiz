(()=>{"use strict";class e{constructor(){this.formElement=null,this.agreeElement=null,this.processElement=null,this.fields=[{name:"firstName",element:null,regex:/^[А-Я][а-я]+\s*$/,valid:!1},{name:"lastName",element:null,regex:/^[А-Я][а-я]+\s*$/,valid:!1},{name:"email",element:null,regex:/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,valid:!1}];const e=this;this.fields.forEach(t=>{t.element=document.getElementById(t.name),t.element.addEventListener("change",function(){e.validateField(t,this)})}),this.agreeElement=document.getElementById("agree"),this.agreeElement.addEventListener("change",function(){e.validateForm()}),this.formElement=document.querySelector(".form"),this.formElement.addEventListener("submit",function(t){t.preventDefault(),e.processForm()}),this.processElement=document.querySelector(".form-btn")}validateField(e,t){t.value&&t.value.match(e.regex)?(t.parentNode.removeAttribute("style"),e.valid=!0):(t.parentNode.style.borderColor="red",e.valid=!1),this.validateForm()}validateForm(){return this.fields.every(e=>e.valid)&&this.agreeElement.checked?(this.processElement.removeAttribute("disabled"),!0):(this.processElement.setAttribute("disabled","disabled"),!1)}processForm(){if(this.validateForm()){const e={};this.fields.forEach(t=>{e[t.name]=t.element.value}),sessionStorage.setItem("user",JSON.stringify(e)),location.href="#/choice"}}}function t(){const e=JSON.parse(sessionStorage.getItem("user"));e.firstName&&e.lastName&&e.email||(location.href="./index.html")}function s(e){const t=new XMLHttpRequest;if(t.open("GET",e,!1),t.send(),200===t.status&&t.responseText)try{return JSON.parse(t.responseText)}catch(e){console.log(e)}else console.log(t.status)}class n{constructor(){this.quizzes=[],t();const e=new XMLHttpRequest;if(e.open("GET","https://testologia.ru/get-quizzes",!1),e.send(),200===e.status&&e.responseText){try{this.quizzes=JSON.parse(e.responseText)}catch(e){console.log(e)}this.processQuizzes()}else console.log(e.status)}processQuizzes(){if(this.quizzes&&this.quizzes.length>0){const e=document.querySelector(".choice-content"),t=this;this.quizzes.forEach(s=>{const n=document.createElement("div");n.className="choice-option",n.setAttribute("data-id",s.id),n.addEventListener("click",function(){t.chooseQuiz(this)});const i=document.createElement("div");i.className="choice-option-text",i.innerText=s.name;const r=document.createElement("div");r.className="choice-option-arrow";const o=document.createElement("img");o.setAttribute("src","./images/arrow.svg"),o.setAttribute("alt","Arrow to right"),r.appendChild(o),n.appendChild(i),n.appendChild(r),e.appendChild(n)})}}chooseQuiz(e){const t=e.getAttribute("data-id");if(t){const e=JSON.parse(sessionStorage.getItem("user"));e.id=t,sessionStorage.setItem("user",JSON.stringify(e)),location.href="#/test"}}}class i{constructor(){this.titleEl=null,this.optionsEl=null,this.quiz=null,this.progressBar=null,this.prevBtnEl=null,this.nextBtnEl=null,this.skipEl=null,this.currentQuestionIndex=1,this.userResult=[],t();const e=JSON.parse(sessionStorage.getItem("user"));e.id?(this.quiz=s("https://testologia.ru/get-quiz?id="+e.id),this.startQuiz()):console.log(e.id)}startQuiz(){document.querySelector(".test-pre-title").innerText=this.quiz.name,this.progressBar=document.querySelector(".test-progress-bar"),this.titleEl=document.querySelector(".test-question"),this.optionsEl=document.querySelector(".test-question-options"),this.skipEl=document.querySelector(".test-action-skip"),this.prevBtnEl=document.querySelector(".test-actions-prev"),this.prevBtnEl.addEventListener("click",()=>{this.move("prev")}),this.nextBtnEl=document.querySelector(".test-actions-next"),this.nextBtnEl.addEventListener("click",()=>{this.move("next")}),document.querySelector(".test-action-skip").addEventListener("click",()=>{this.move("skip")}),this.prepareProgressBar(),this.showQuestion();const e=document.querySelector(".test-actions-time-clock");let t=59;const s=setInterval(function(){e.innerText=t,t--,0===t&&(clearInterval(s),this.complete())}.bind(this),1e3)}prepareProgressBar(){for(let e=0;e<this.quiz.questions.length;e++){const t=document.createElement("div");t.className="progress-bar-item"+(0===e?" active":"");const s=document.createElement("div");s.className="progress-bar-item-circle";const n=document.createElement("div");n.className="progress-bar-item-text",n.innerText=`Вопрос ${e+1}`,t.appendChild(s),t.appendChild(n),this.progressBar.appendChild(t)}}showQuestion(){const e=this,t=this.quiz.questions[this.currentQuestionIndex-1],s=this.userResult.find(e=>e.questionId===t.id);this.titleEl.innerHTML=`<span>Вопрос ${this.currentQuestionIndex}:</span> ${t.question}`,this.optionsEl.innerHTML="",t.answers.forEach(t=>{const n=document.createElement("div");n.className="test-question-option";const i=document.createElement("input");i.className="option-answer",i.setAttribute("id","answer-"+t.id),i.setAttribute("type","radio"),i.setAttribute("name","answer"),i.setAttribute("value",t.id),s&&s.chosenAnswerId===t.id&&(i.setAttribute("checked","checked"),e.skipEl.classList.add("disabled")),i.addEventListener("change",function(){e.chooseAnswer()});const r=document.createElement("label");r.setAttribute("for","answer-"+t.id),r.innerText=t.answer,n.appendChild(i),n.appendChild(r),e.optionsEl.appendChild(n)}),s&&s.chosenAnswerId?this.nextBtnEl.removeAttribute("disabled"):(this.nextBtnEl.setAttribute("disabled","disabled"),this.skipEl.classList.remove("disabled")),this.currentQuestionIndex===this.quiz.questions.length?(this.nextBtnEl.innerText="Завершить",this.skipEl.classList.add("disabled")):this.nextBtnEl.innerText="Дальше",this.currentQuestionIndex>1?this.prevBtnEl.removeAttribute("disabled"):this.prevBtnEl.setAttribute("disabled","disabled")}chooseAnswer(){this.nextBtnEl.removeAttribute("disabled"),this.skipEl.classList.add("disabled")}move(e){const t=Array.from(document.querySelectorAll(".option-answer")).find(e=>e.checked),s=this.quiz.questions[this.currentQuestionIndex-1];let n=null;t&&t.value&&(n=Number(t.value));const i=this.userResult.find(e=>e.questionId===s.id);i?i.choosenAnswerId=n:this.userResult.push({questionId:s.id,chosenAnswerId:n}),"next"===e||"skip"===e?this.currentQuestionIndex++:this.currentQuestionIndex--,this.currentQuestionIndex>this.quiz.questions.length?this.complete():(Array.from(this.progressBar.children).forEach((e,t)=>{e.classList.remove("complete"),e.classList.remove("active"),t+1===this.currentQuestionIndex?e.classList.add("active"):t+1<this.currentQuestionIndex&&e.classList.add("complete")}),this.showQuestion())}complete(){const e=JSON.parse(sessionStorage.getItem("user")),t=new XMLHttpRequest;if(t.open("POST","https://testologia.ru/pass-quiz?id="+e.id,!1),t.setRequestHeader("Content-Type","application/json;charset=UTF-8"),t.send(JSON.stringify({name:e.firstName,lastName:e.lastName,email:e.email,results:this.userResult})),200===t.status&&t.responseText){let s=null;try{s=JSON.parse(t.responseText)}catch(e){console.log(e)}s&&(e.results=this.userResult,e.score=s.score,e.total=s.total,sessionStorage.setItem("user",JSON.stringify(e)),location.href="#/result")}else console.log(t.status)}}class r{constructor(){new URL(location.href);const e=JSON.parse(sessionStorage.getItem("user"));document.querySelector(".result-score").innerText=`${e.score}/${e.total}`}}class o{constructor(){this.user=null,this.quiz=null,this.answers=null,this.answerBoxEl=null,this.answerBoxEl=document.querySelector(".answers-box"),this.user=JSON.parse(sessionStorage.getItem("user")),this.user.id?(this.quiz=s("https://testologia.ru/get-quiz?id="+this.user.id),this.answers=s("https://testologia.ru/get-quiz-right?id="+this.user.id),document.querySelector(".answers-bread-crumbs-current").innerText=this.quiz.name,document.querySelector(".answers-user").innerText=`${this.user.firstName} ${this.user.lastName}, ${this.user.email}`,this.showAnswers()):console.log(this.user.id)}showAnswers(){for(let e=0;e<this.quiz.questions.length;e++){const t=document.createElement("div");t.className="answers-answer",t.innerHTML=`<span>Вопрос ${e+1}:</span> ${this.quiz.questions[e].question}`,this.answerBoxEl.appendChild(t);for(let t=0;t<this.quiz.questions[e].answers.length;t++){const s=document.createElement("div");s.className="answers-user-answer",this.user.results[e].chosenAnswerId===this.quiz.questions[e].answers[t].id&&(this.user.results[e].chosenAnswerId===this.answers[e]?s.classList.add("correct"):s.classList.add("uncorrect")),s.innerText=this.quiz.questions[e].answers[t].answer,this.answerBoxEl.appendChild(s)}}}}class l{constructor(){this.routes=[{route:"#/",title:"Главная",template:"templates/index.html",styles:"styles/index.css",load:()=>{}},{route:"#/form",title:"Регистрация",template:"templates/form.html",styles:"styles/form.css",load:()=>{new e}},{route:"#/choice",title:"Выбор теста",template:"templates/choice.html",styles:"styles/choice.css",load:()=>{new n}},{route:"#/test",title:"Прохождение теста",template:"templates/test.html",styles:"styles/test.css",load:()=>{new i}},{route:"#/result",title:"Результат",template:"templates/result.html",styles:"styles/result.css",load:()=>{new r}},{route:"#/answers",title:"Ответы",template:"templates/answers.html",styles:"styles/answers.css",load:()=>{new o}}]}async openRoute(){const e=this.routes.find(e=>e.route===window.location.hash);e?(document.getElementById("content").innerHTML=await fetch(e.template).then(e=>e.text()),document.getElementById("styles").setAttribute("href",e.styles),document.getElementById("title").innerText=e.title,e.load()):window.location.href="#/"}}new class{constructor(){this.router=new l,window.addEventListener("DOMContentLoaded",this.handleRouteChanging.bind(this)),window.addEventListener("popstate",this.handleRouteChanging.bind(this))}handleRouteChanging(){this.router.openRoute()}}})();